name: PR Architecture Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**/*.py'

permissions:
  contents: read
  pull-requests: write

jobs:
  architecture-review:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout PR branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install PyVisualizer
      run: |
        python -m pip install --upgrade pip
        pip install -e .

    - name: Get changed Python files
      id: changed-files
      run: |
        # Get list of changed Python files
        git fetch origin ${{ github.event.pull_request.base.ref }}
        CHANGED=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD -- '*.py' | grep -v "^tests/" | head -50 || true)
        if [ -z "$CHANGED" ]; then
          echo "files=" >> $GITHUB_OUTPUT
          echo "count=0" >> $GITHUB_OUTPUT
        else
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "count=$(echo "$CHANGED" | wc -l | tr -d ' ')" >> $GITHUB_OUTPUT
        fi

    - name: Generate architecture diagram
      if: steps.changed-files.outputs.count != '0'
      run: |
        mkdir -p /tmp/pr-diagrams
        
        # Generate diagram for affected modules
        py-code-visualizer . \
          --format mermaid \
          --output /tmp/pr-diagrams/architecture.mmd \
          --project-name "PR #${{ github.event.pull_request.number }}" \
          --max-nodes 75 \
          --exclude tests examples
        
        # Generate HTML for artifact
        py-code-visualizer . \
          --format html \
          --output /tmp/pr-diagrams/architecture.html \
          --project-name "PR #${{ github.event.pull_request.number }}" \
          --max-nodes 75 \
          --exclude tests examples

    - name: Generate stats
      if: steps.changed-files.outputs.count != '0'
      id: stats
      run: |
        # Count functions and calls in the diagram
        FUNCTIONS=$(grep -c "node[0-9]" /tmp/pr-diagrams/architecture.mmd || echo "0")
        EDGES=$(grep -c "\-\->" /tmp/pr-diagrams/architecture.mmd || echo "0")
        
        echo "functions=$FUNCTIONS" >> $GITHUB_OUTPUT
        echo "edges=$EDGES" >> $GITHUB_OUTPUT

    - name: Create PR comment
      if: steps.changed-files.outputs.count != '0'
      uses: actions/github-script@v7
      with:
        script: |
          const changedFiles = `${{ steps.changed-files.outputs.files }}`.split('\n').filter(f => f.trim());
          const filesList = changedFiles.slice(0, 10).map(f => `  - \`${f}\``).join('\n');
          const moreFiles = changedFiles.length > 10 ? `\n  - ... and ${changedFiles.length - 10} more` : '';
          
          const comment = `## üèóÔ∏è Architecture Analysis
          
          ### üìä Overview
          
          | Metric | Value |
          |--------|-------|
          | **Changed Files** | ${{ steps.changed-files.outputs.count }} |
          | **Functions Visualized** | ${{ steps.stats.outputs.functions }} |
          | **Call Relationships** | ${{ steps.stats.outputs.edges }} |
          
          ### üìù Changed Python Files
          ${filesList}${moreFiles}
          
          ### üîç Interactive Diagram
          
          Download and open the HTML artifact for an interactive view of the code architecture.
          
          ---
          *Generated by [PyVisualizer](https://github.com/haider1998/PyVisualizer) üé®*
          `;
          
          // Find existing comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(c => 
            c.user.type === 'Bot' && 
            c.body.includes('üèóÔ∏è Architecture Analysis')
          );
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: comment
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
          }

    - name: Upload diagram artifact
      if: steps.changed-files.outputs.count != '0'
      uses: actions/upload-artifact@v4
      with:
        name: architecture-diagram-pr-${{ github.event.pull_request.number }}
        path: /tmp/pr-diagrams/
        retention-days: 14
